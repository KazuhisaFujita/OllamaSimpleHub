# 📝 UI（フロントエンド）要件定義書

## 1. プロジェクト概要

* **プロジェクト名**: `OllamaSimpleHub` Web UI
* **目的**:
    バックエンドAPI（`OllamaSimpleHub`）と通信し、「最終回答」「レビュー」「ワーカー回答」を分離して表示する、インタラクティブなWebチャットUIを構築する。
* **技術スタック**:
    HTML5, CSS3, JavaScript (ES6+) (ピュアHTML/CSS/JS、フレームワーク非依存)
* **対応ブラウザ**:
    モダンブラウザ（Chrome, Firefox, Safari, Edge）の最新版

---

## 2. UI機能要件 (UI Functional Requirements)

### UFR1: 基本レイアウト構成

#### 1.1 ページヘッダー
* **タイトル表示**: `<h1>`でアプリケーション名「OllamaSimpleHub」を表示
* **説明文**: マルチエージェントシステムの簡単な説明を表示（1-2行）

#### 1.2 チャットエリア
* **チャットコンテナ (`<div id="chat-container">`)**:
    * 会話の全履歴（ユーザーの質問、アシスタントの応答ブロック）が表示される
    * スクロール可能なメイン領域（固定高さ、overflow-y: auto）
    * 背景色や境界線で視覚的に区別されたエリア

#### 1.3 入力エリア
* **入力フォーム (`<form id="chat-form">`)**:
    * テキストボックス (`<input type="text" id="user-input" />`)
        - プレースホルダーテキスト（例: "質問を入力してください..."）
        - 最大文字数制限: 10000文字（バックエンドと一致）
    * 送信ボタン (`<button type="submit" id="send-button">送信</button>`)
        - 送信中は無効化（disabled）され、ローディング表示に変化

#### 1.4 コントロールエリア（オプション）
* **会話リセットボタン**: 会話履歴を全クリアする
* **接続ステータス表示**: APIサーバーとの接続状態（オプション）

---

### UFR2: 会話の表示フロー

#### 2.1 ユーザーメッセージの表示
* **送信時の動作**:
    1. フォームを送信すると、入力されたテキストが即座に「ユーザー用」チャットバブルとして`chat-container`に追加される
    2. 入力フィールドはクリアされる
    3. 送信ボタンが無効化され、ローディング状態を示す（例: "送信中..."）

* **見た目の要件**:
    * ユーザーメッセージは右寄せで表示
    * 背景色で識別可能（例: 青系の色）
    * アイコンまたは「あなた」のラベルを表示（オプション）

#### 2.2 アシスタント応答の表示
* **受信時の動作**:
    1. APIからレスポンスを受信後、単一の「アシスタント用」チャットブロックを`chat-container`に追加
    2. このブロックは**3つのセクション**を**指定された順序で**含む（詳細はUFR3参照）
    3. 送信ボタンを再び有効化

* **見た目の要件**:
    * アシスタントメッセージは左寄せで表示
    * ユーザーメッセージと異なる背景色（例: 白またはグレー系）
    * アイコンまたは「AI」のラベルを表示（オプション）

---

### UFR3: アシスタント応答ブロックの構成

APIレスポンスから受け取る3つの要素を、以下の順序とスタイルで表示すること。

#### セクション1: ワーカーの回答（開閉式）

* **見出し**: `<h3>` または `<h4>` で「🧠 各ワーカーの回答」を表示
* **トグルボタン**: 
    * ボタンテキスト: `[▶ 詳細を表示]` / `[▼ 詳細を隠す]`
    * `<button class="toggle-workers">` でスタイリング可能
* **ワーカー回答リスト (`<div class="worker-list">`)**:
    * **デフォルト状態**: 非表示（`display: none;`）
    * 各ワーカーの回答を表示:
        - ワーカー名（`agent_name`）: 太字で表示
        - 処理時間（`processing_time`）: 小さいフォントで表示（例: "0.5秒"）
        - 回答内容（`response`）: 通常のテキストとして表示
        - 成否（`is_success`）: 失敗時は赤文字でエラーメッセージを表示
    * 各ワーカーの回答は視覚的に区切る（例: 境界線、背景色の違い）
* **トグル動作**:
    * ボタンをクリックすると、`worker-list`の表示/非表示を切り替え
    * ボタンのテキストとアイコン（▶/▼）も連動して変化

#### セクション2: レビューワーの評価（常時表示）

* **見出し**: `<h3>` または `<h4>` で「🤖 レビューワーの評価」を表示
* **評価内容**: 
    * APIレスポンスの`review_comment`をそのまま表示
    * 改行を尊重してフォーマット（`white-space: pre-wrap;` を推奨）
    * 薄いグレーの背景色で囲むなど、視覚的に区別

#### セクション3: 最終回答（常時表示、最も目立つ）

* **見出し**: `<h3>` で「💡 最終回答」を**強調表示**（太字、大きめのフォント）
* **回答内容**:
    * APIレスポンスの`final_answer`を表示
    * 改行を尊重してフォーマット（`white-space: pre-wrap;`）
    * 背景色で強調（例: 薄い黄色やハイライト）
    * この部分が最も読みやすく、注目されるようにデザイン

---

### UFR4: 会話履歴の管理とAPI通信

#### 4.1 クライアント側の会話履歴管理

* **履歴の保存場所**:
    * JavaScript配列変数（例: `let messages = [];`）で管理
    * ブラウザのlocalStorageやsessionStorageは使用しない（セッション内のみ）

* **履歴の内容**:
    * `{"role": "user", "content": "ユーザーの質問"}`
    * `{"role": "assistant", "content": "最終回答のみ"}`
    * **注意**: `worker_responses`や`review_comment`は履歴に含めない

* **履歴のクリア**:
    * 「会話リセット」ボタンをクリックすると、`messages`配列を空にし、チャットコンテナをクリア

#### 4.2 APIリクエスト仕様

* **エンドポイント**: `POST /api/v1/generate`
* **リクエストヘッダー**: 
    ```
    Content-Type: application/json
    ```
* **リクエストボディ（初回）**:
    ```json
    {
      "prompt": "ユーザーの最初の質問"
    }
    ```
* **リクエストボディ（2回目以降）**:
    ```json
    {
      "messages": [
        {"role": "user", "content": "最初の質問"},
        {"role": "assistant", "content": "最初の最終回答"},
        {"role": "user", "content": "次の質問"}
      ]
    }
    ```

* **実装方法**:
    1. `messages`配列が空の場合: `{"prompt": "..."}`形式で送信
    2. `messages`配列に履歴がある場合: 最新のユーザー入力を追加し、`{"messages": [...]}`形式で送信

#### 4.3 APIレスポンス処理

* **成功時**:
    1. レスポンスJSON（`final_answer`, `review_comment`, `worker_responses`, `metadata`を含む）を解析
    2. UFR3の仕様に従ってHTMLを動的に生成し、DOMに追加
    3. `final_answer`のみを `{"role": "assistant", "content": "..."}`として`messages`配列に追加
    4. チャットコンテナを最下部までスクロール

* **エラー時**:
    * ネットワークエラー、サーバーエラー（500番台）、タイムアウトなどを検知
    * エラーメッセージをチャットコンテナに赤いバブルで表示（例: "⚠️ サーバーとの通信に失敗しました"）

---

### UFR5: インタラクション要件

#### 5.1 キーボードショートカット
* **Enter キー**: フォーム送信（デフォルト動作）
* **Shift + Enter**: 改行（オプション、複数行入力対応時）

#### 5.2 ボタンの状態管理
* **送信ボタン**:
    * 入力フィールドが空の場合: 無効化（disabled）
    * 送信中: 無効化 + テキスト変更（"送信中..."）+ ローディングアイコン（オプション）
    * 通常時: 有効化

#### 5.3 自動スクロール
* 新しいメッセージが追加された際、`chat-container`を自動的に最下部までスクロール
* スムーズスクロール（`behavior: 'smooth'`）を使用

---

## 3. UI非機能要件 (UI Non-Functional Requirements)

### UNFR1: レスポンシブデザイン
* **デスクトップ**: 画面幅 1024px 以上で最適化
* **タブレット**: 画面幅 768px - 1023px で読みやすいレイアウト
* **スマートフォン**: 画面幅 767px 以下では、入力フィールドとボタンが縦並びになるなど調整（オプション）

### UNFR2: スタイリング
* **視覚的な区別**: ユーザーとアシスタントのメッセージは、背景色、配置（左/右）、アイコンで明確に区別
* **読みやすさ**: 
    * フォントサイズ: 14px - 16px（本文）
    * 行間: 1.5 - 1.8
    * コントラスト: WCAG AA レベルを推奨
* **統一感**: 色、フォント、余白が全体で統一されたデザイン

### UNFR3: パフォーマンス
* **初期ロード時間**: 1秒以内（外部ライブラリなし、静的ファイルのみ）
* **DOM操作**: 大量の会話履歴（100件以上）でも、スクロールやトグルがスムーズに動作
* **APIレスポンス待機**: タイムアウト設定（30秒推奨）で、無限待機を防ぐ

### UNFR4: エラーハンドリング
* **API通信失敗**: ユーザーにわかりやすいエラーメッセージを表示（日本語）
* **無効な入力**: 空の入力や文字数超過を送信前にブロック
* **予期しないレスポンス**: APIが想定外の形式を返した場合、クラッシュせずエラー表示

### UNFR5: アクセシビリティ
* **セマンティックHTML**: 適切なタグ（`<button>`, `<form>`, `<input>`）を使用
* **キーボードナビゲーション**: タブキーで全ての操作可能な要素に移動可能
* **ARIA属性**: トグルボタンなどには`aria-expanded`属性を設定（推奨）

### UNFR6: 独立性
* **バックエンド依存**: `OllamaSimpleHub`のAPI仕様（`POST /api/v1/generate`）のみに依存
* **外部依存なし**: CDNやnpm パッケージを使用せず、単一のHTMLファイル + CSS + JSで動作
* **ポータビリティ**: 任意のWebサーバー（FastAPIの静的ファイル配信、nginx、Apache等）で配信可能

---

## 4. 技術仕様

### 4.1 ファイル構成
```
/ui
  ├── index.html       # メインHTMLファイル
  ├── style.css        # スタイルシート
  └── app.js           # JavaScript（ロジック）
```

または、単一ファイル版:
```
/ui
  └── index.html       # HTML + CSS（<style>内） + JS（<script>内）
```

### 4.2 使用技術
* **HTML5**: セマンティックタグ、フォーム要素
* **CSS3**: Flexbox/Grid レイアウト、トランジション、メディアクエリ
* **JavaScript (ES6+)**:
    * `fetch()` API によるHTTP通信
    * `async/await` による非同期処理
    * DOM操作（`createElement`, `appendChild`, `classList`, `scrollIntoView` 等）
    * イベントリスナー（`addEventListener`）

### 4.3 ブラウザAPI
* **Fetch API**: APIリクエスト送信
* **DOM API**: 要素の作成・追加・削除
* **Event API**: ユーザーインタラクションの処理

---

## 5. データフロー

### 5.1 ユーザー操作からAPI呼び出しまで
```
1. ユーザーがテキスト入力 → フォーム送信
2. JavaScript: 入力をバリデーション
3. JavaScript: messages配列に {"role": "user", "content": "..."} を追加
4. JavaScript: fetch()で POST /api/v1/generate にリクエスト送信
   - 初回: {"prompt": "..."}
   - 2回目以降: {"messages": [...]}
5. サーバー処理（バックエンド）
6. JavaScript: レスポンスを受信
```

### 5.2 APIレスポンスからUI更新まで
```
7. JavaScript: レスポンスJSON解析
   - final_answer, review_comment, worker_responses, metadata を取得
8. JavaScript: HTMLブロック生成
   - セクション1（ワーカー回答）: トグルボタン + 非表示リスト
   - セクション2（レビュー評価）: 常時表示
   - セクション3（最終回答）: 強調表示
9. JavaScript: DOMに追加（chat-container.appendChild()）
10. JavaScript: final_answerのみをmessages配列に追加
11. JavaScript: 自動スクロール（chat-container.scrollTop = scrollHeight）
12. UI: ユーザーが次の質問を入力可能に
```

---

## 6. API仕様（参照用）

### 6.1 エンドポイント
* **URL**: `http://localhost:8000/api/v1/generate`
* **メソッド**: `POST`
* **Content-Type**: `application/json`

### 6.2 リクエストスキーマ
```typescript
{
  prompt?: string,                    // 単発の質問（初回）
  messages?: Array<{                  // 会話履歴（2回目以降）
    role: "user" | "assistant",
    content: string
  }>
}
```

### 6.3 レスポンススキーマ
```typescript
{
  final_answer: string,               // レビューワーの最終回答
  review_comment: string,             // レビューワーの評価コメント
  worker_responses: Array<{           // 各ワーカーの回答
    agent_name: string,
    response: string,
    is_success: boolean,
    processing_time: number
  }>,
  metadata: {                         // 処理のメタデータ
    total_workers: number,
    successful_workers: number,
    failed_workers: number,
    processing_time_seconds: number
  }
}
```

---

## 7. 将来の拡張（オプション）

以下は初期バージョンでは不要だが、将来的に検討可能な機能:

* **Markdown表示**: `final_answer`や`review_comment`内のMarkdownをHTMLにレンダリング
* **コードハイライト**: コードブロックをシンタックスハイライト表示
* **エクスポート機能**: 会話履歴をJSON/テキストファイルでダウンロード
* **テーマ切り替え**: ダークモード / ライトモード
* **会話の保存/読み込み**: localStorageやサーバー連携で過去の会話を復元
* **音声入力**: Web Speech API を使った音声認識
* **ストリーミング表示**: サーバーからのストリーミングレスポンスに対応

---

## 8. 制約事項

* **単一ユーザー**: 複数ユーザーの同時利用や認証機能はサポートしない
* **セキュリティ**: 本番環境では、CORS設定、HTTPS、入力サニタイズ等を適切に実装すること
* **ブラウザ互換性**: IE11 はサポート対象外
* **API依存**: バックエンドAPIの仕様変更に伴い、UIも更新が必要

---

## 9. 成功基準

以下の全てを満たすことで、要件を満たしたと判断する:

1. ✅ ユーザーが質問を入力し、送信ボタンを押すと、APIリクエストが送信される
2. ✅ サーバーからのレスポンスが「最終回答」「レビュー評価」「ワーカー回答」の3セクションで表示される
3. ✅ ワーカー回答は初期状態で非表示、トグルボタンで表示/非表示を切り替えられる
4. ✅ 2回目以降の質問で、会話履歴（`messages`配列）が正しくAPIに送信される
5. ✅ 新しいメッセージが追加されると、チャットコンテナが自動的に最下部までスクロールする
6. ✅ API通信エラー時、ユーザーにわかりやすいエラーメッセージが表示される
7. ✅ ユーザーとアシスタントのメッセージが、視覚的に明確に区別できる
8. ✅ 外部ライブラリなしで動作し、単一または複数の静的ファイルで配信可能

---

## 10. 参考情報

* **FastAPI CORS設定**: フロントエンドからのAPIアクセスを許可するため、バックエンドで適切なCORSミドルウェアを設定すること
* **バックエンドドキュメント**: `REQUIREMENTS.md`, `README.md` を参照
* **テストクライアント**: `examples/test_client.py`, `examples/chat_cli.py` でAPIの動作確認可能

---

**以上、UI要件定義書とする。**
